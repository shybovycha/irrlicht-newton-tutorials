<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="yandex-verification" content="665c9a724ffb44f6" />
  
  <title>The First Script</title>
  <meta name="description" content="The first scriptAs we discussed, we will describe the whole game in scripts, and the core functionalitywe will define in the core. In this chapter we will be...">

  <link rel="stylesheet" href="/irrlicht-newton-tutorials/css/main.css">
  <link rel="canonical" href="http://shybovycha.github.io/irrlicht-newton-tutorials//irrlicht-newton-tutorials/2015/08/28/the-first-script.html">
  <link rel="alternate" type="application/rss+xml" title="Irrlicht Newton Tutorials" href="http://shybovycha.github.io/irrlicht-newton-tutorials//irrlicht-newton-tutorials/feed.xml" />

  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
  <script type="text/javascript" src="/irrlicht-newton-tutorials/js/bootstrap.min.js"></script>
</head>


  <body>
    <div class="container-fluid wrapper">
      <div class="box">
        <div class="row">
          <div class="column col-sm-3" id="sidebar">
            <a class="logo" href="/irrlicht-newton-tutorials/">G</a>



<ul class="nav">
  
    
    <li >
      <a href="/irrlicht-newton-tutorials/2015/08/28/introduction.html">Introduction</a>
    </li>
  
    
    <li >
      <a href="/irrlicht-newton-tutorials/2015/08/28/application-architecture.html">Application Architecture</a>
    </li>
  
    
    <li >
      <a href="/irrlicht-newton-tutorials/2015/08/28/first-application.html">First Application</a>
    </li>
  
    
    <li class="active">
      <a href="/irrlicht-newton-tutorials/2015/08/28/the-first-script.html">The First Script</a>
    </li>
  
    
    <li >
      <a href="/irrlicht-newton-tutorials/2015/08/28/adding-some-newtonality.html">Adding Some Newtonality</a>
    </li>
  
</ul>

<div class="hidden-xs" id="sidebar-footer">
  <footer class="site-footer">
  <div class="row">
    <div class="col-sm-6 text-center">
      <a class="btn btn-info" href="https://github.com/shybovycha/irrlicht-newton-tutorials">
          <span class="icon icon-github">
            <svg viewBox="0 0 16 16" style="width: 16px; height: 16px;">
              <path fill="#000" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
            </svg>
          </span>

          Get the code!
      </a>
    </div>

    <div class="col-sm-6 text-center">
      
      <a class="btn btn-info" href="https://twitter.com/shybovycha">
          <span class="icon icon-twitter">
            <svg viewBox="0 0 16 16" style="width: 16px; height: 16px;">
              <path fill="#fff" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
              c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
            </svg>
          </span>

          <span class="username">@shybovycha</span>
      </a>
      
    </div>
  </div>
</footer>

</div>

          </div>

          <div class="column col-sm-9" id="main">
            <div class="row">
  <h1 id="the-first-script">The first script</h1>

<p>As we discussed, we will describe the whole game in scripts, and the core functionality
we will define in the core. In this chapter we will be adding <strong>Lua</strong> to our application.
You do not need to download Lua itself - you’d better install it with your system’s
package manager <em>(<code>yum</code> or <code>apt</code> or whatever your Linux uses, <code>brew</code> for OSX…)</em>.</p>

<h2 id="dependencies">Dependencies</h2>

<p>The only thing you need to download from Internet this time is Lua wrapper called
<strong>luacppinterface</strong>.
So <a href="https://github.com/davidsiaw/luacppinterface/archive/master.zip"><strong>go and get it</strong></a> from
Github.</p>

<p>And unpack it… right to the <code>source</code> directory of our project! That’s right! That’s
really small library so it will not pollute your project with tons of files.</p>

<p>Now, I mentioned dependency managers earlier. This is how <em>we</em> will handle them in our <em>C++</em>
application - we will simply put the sources of all the libraries we depend on, with the
versions we depend on, right in our project. Given that, you may put Irrlicht there as well -
you are free to do anything with our project!</p>

<h2 id="build-instructions">Build instructions</h2>

<p>To build our project we will need to change our <code>CMakeLists.txt</code> file to fetch
our new dependency:</p>

<figure class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.1</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">irrlicht_newton_game1</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span> <span class="s2">&quot;${CMAKE_CXX_FLAGS} -std=c++11&quot;</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">SOURCE_FILES</span> <span class="s">source/main.cpp</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">EXECUTABLE_NAME</span> <span class="s">irrlicht_newton_game1</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">LUACPPINTERFACE_PATH</span> <span class="s">source/luacppinterface-master</span><span class="p">)</span>

<span class="nb">add_subdirectory</span><span class="p">(</span><span class="o">${</span><span class="nv">LUACPPINTERFACE_PATH</span><span class="o">}</span><span class="p">)</span>

<span class="nb">find_package</span><span class="p">(</span><span class="s">X11</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">OpenGL</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">ZLIB</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Lua</span><span class="p">)</span>

<span class="nb">if</span> <span class="p">(</span><span class="s">NOT</span> <span class="s">IRRLICHT_LIBRARY_PATH</span><span class="p">)</span>
    <span class="nb">find_library</span><span class="p">(</span><span class="s">IRRLICHT_LIBRARY_PATH</span>
            <span class="s">NAMES</span> <span class="s">Irrlicht</span>
            <span class="s">PATHS</span> <span class="o">${</span><span class="nv">IRRLICHT_PATH</span><span class="o">}</span><span class="s">/lib/</span>
            <span class="s">PATH_SUFFIXES</span> <span class="s">Linux</span> <span class="s">MacOSX</span> <span class="s">Win32-gcc</span> <span class="s">Win32-visualstudio</span> <span class="s">Win64-visualstudio</span><span class="p">)</span>

    <span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span> <span class="s2">&quot;Found Irrlicht: ${IRRLICHT_LIBRARY_PATH}&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">IRRLICHT_PATH</span><span class="o">}</span><span class="s">/include</span> <span class="o">${</span><span class="nv">LUA_INCLUDE_DIR</span><span class="o">}</span> <span class="o">${</span><span class="nv">LUACPPINTERFACE_PATH</span><span class="o">}</span><span class="s">/include</span><span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTABLE_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">SOURCE_FILES</span><span class="o">}</span><span class="p">)</span>

<span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">EXECUTABLE_NAME</span><span class="o">}</span>
        <span class="s">luacppinterface</span>
        <span class="o">${</span><span class="nv">IRRLICHT_LIBRARY_PATH</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">X11_LIBRARIES</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">OPENGL_LIBRARIES</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">ZLIB_LIBRARIES</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">X11_Xxf86vm_LIB</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">LUA_LIBRARIES</span><span class="o">}</span><span class="p">)</span></code></pre></figure>

<p>And here’s the thing: if you try to compile our project on another machine, you will
not need to install any other libraries than Lua on that machine! That supposed to sound
like <em>“sweet, huh?”</em>, except that one little <em>“but…“</em>… Bittersweet…</p>

<p>Back to our busines… <code>luacppinterface</code> needs to be tweaked a bit to fit our project -
we will hack its <code>CMakeLists.txt</code> file to make it depend on system Lua libraries.
Just make it look like this:</p>

<figure class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">cmake_minimum_required</span> <span class="p">(</span><span class="s">VERSION</span> <span class="s">2.6</span><span class="p">)</span>

<span class="nb">project</span><span class="p">(</span><span class="s">luacppinterface</span><span class="p">)</span>

<span class="nb">include_directories</span><span class="p">(</span><span class="s2">&quot;lua/src&quot;</span><span class="p">)</span>

<span class="nb">find_package</span><span class="p">(</span><span class="s">Lua</span><span class="p">)</span>

<span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">LUA_INCLUDE_DIR</span><span class="o">}</span><span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span><span class="s">luacppinterface</span> <span class="s">STATIC</span>
    <span class="s">include/luacoroutine.cpp</span>
    <span class="s">include/luareference.cpp</span>
    <span class="s">include/luacppinterface.cpp</span>
    <span class="s">include/luatable.cpp</span>
    <span class="s">include/luafunction.cpp</span>
<span class="p">)</span>

<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">luacppinterface</span> <span class="o">${</span><span class="nv">LUA_LIBRARIES</span><span class="o">}</span><span class="p">)</span></code></pre></figure>

<p>It barely differs from the original file, but it makes a compilation pleasant - you
do not need to specify paths to Lua libs anymore!</p>

<h2 id="injecting-some-lua">Injecting some Lua</h2>

<p>Our application now uses C++ code to place some 3D objects in a scene. Let’s move,
say, sphere creation, to the script.</p>

<p>First of all, add <code>luacppinterface</code> headers to our <code>main.cpp</code> file:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &quot;luacppinterface-master/include/luacppinterface.h&quot;</span></code></pre></figure>

<p>Now let’s look at some of Irrlicht’ conventions:</p>

<ul>
  <li>it uses <code>irr::video::IVideoDriver</code> for rendering operations</li>
  <li>it uses <code>irr::scene::ISceneManager</code> for scene management</li>
</ul>

<p>So why not to define a <code>ScriptManager</code> to handle scripts? Our requirements
for this class (for now) are:</p>

<ul>
  <li>it should load and evaluate scripts</li>
  <li>it should provide simple API to our scripts</li>
</ul>

<p>Let’s get coding!</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">ScriptManager</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
    <span class="n">Lua</span> <span class="n">luaState</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">scene</span><span class="o">::</span><span class="n">ISceneNode</span><span class="o">*&gt;</span> <span class="n">nodes</span><span class="p">;</span>
    <span class="n">video</span><span class="o">::</span><span class="n">IVideoDriver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
    <span class="n">scene</span><span class="o">::</span><span class="n">ISceneManager</span> <span class="o">*</span><span class="n">smgr</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">bindFunctions</span><span class="p">();</span>

<span class="k">public</span><span class="o">:</span>
    <span class="n">ScriptManager</span><span class="p">(</span><span class="n">scene</span><span class="o">::</span><span class="n">ISceneManager</span> <span class="o">*</span><span class="n">_smgr</span><span class="p">,</span> <span class="n">video</span><span class="o">::</span><span class="n">IVideoDriver</span> <span class="o">*</span><span class="n">_driver</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">_driver</span><span class="p">;</span>
        <span class="n">smgr</span> <span class="o">=</span> <span class="n">_smgr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">createSphereNode</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">textureFile</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">setNodePosition</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">LuaTable</span> <span class="n">pos</span><span class="p">);</span>

    <span class="n">LuaTable</span> <span class="nf">getNodePosition</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">loadScript</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">inf</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">code</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">istreambuf_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inf</span><span class="p">)),</span> <span class="n">std</span><span class="o">::</span><span class="n">istreambuf_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">());</span>

        <span class="n">bindFunctions</span><span class="p">();</span>

        <span class="n">luaState</span><span class="p">.</span><span class="n">RunScript</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure>

<p>This is just a skeleton - we will fill it out in a minute. Just catching up:</p>

<ol>
  <li>this class depends on <code>IVideoDriver</code> and <code>ISceneManager</code> to handle 3D objects and the scene</li>
  <li>it contains <code>Lua luaState</code> field to store the current state of our script running</li>
  <li>it stores all the nodes as a <code>&lt;string, ISceneNode*&gt;</code> map to allow access to our nodes from scripts</li>
  <li>it exposes three methods as an API to Lua scripts: <code>createSphereNode</code>, <code>setNodePosition</code> and
  <code>getNodePosition</code> so we will be able to make some manipulations in our scripts</li>
  <li>it provides really short and simple interface to our C++ core: <code>ScriptManager(...)</code> and <code>loadScript</code></li>
</ol>

<p>The main principle, each and every programmer breaks every day is <strong>KISS</strong> <em>(Keep It Stupidly Simple)</em>.
And that principle should guide us through this whole tutorial to not overthink and override
ourselves as well as the project we are making. That is why our APIs are that simple.</p>

<p>But let’s get back to our <code>ScriptManager</code>. It shows how things will look like, but never
defines how they will actually <strong>work</strong>. So here are the key points to Lua API:</p>

<ol>
  <li>
    <p><code>LuaTable</code> is an array-like structure in Lua, representing both indexed as well as key-value
  arrays in Lua. This type is a way to pass variables between Lua script and C++ program. You
  may use both <code>table.Get&lt;value_type&gt;(index)</code> and <code>table.Get&lt;value_type&gt;("key")</code> methods
  to access its values.</p>
  </li>
  <li>
    <p>To bind our <code>ScriptManager</code> methods to Lua functions, we need to use pointers to those
  functions. And as it is not that simple in usual C++, we will use C++11x lambdas:</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp">  <span class="k">auto</span> <span class="n">createSphere</span> <span class="o">=</span> <span class="n">luaState</span><span class="p">.</span><span class="n">CreateFunction</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">)</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span> <span class="n">createSphereNode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tex</span><span class="p">);</span> <span class="p">});</span>
  </code></pre></figure>

<ol>
  <li>All the functions and variables you want to pass to Lua scripts should be global. And since
  we have our pretty <code>luaState</code> member, we may set global members through its methods:</li>
</ol>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp">  <span class="n">LuaTable</span> <span class="n">global</span> <span class="o">=</span> <span class="n">luaState</span><span class="p">.</span><span class="n">GetGlobalEnvironment</span><span class="p">();</span>

  <span class="c1">// ...</span>

  <span class="n">global</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;createSphere&quot;</span><span class="p">,</span> <span class="n">createSphere</span><span class="p">);</span>
  </code></pre></figure>

<ol>
  <li>We will be using just a map of a Irrlicht’ nodes and its name to bypass those nodes between
  scripts and core:</li>
</ol>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp">  <span class="kt">void</span> <span class="nf">createSphereNode</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">textureFile</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">scene</span><span class="o">::</span><span class="n">ISceneNode</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">smgr</span><span class="o">-&gt;</span><span class="n">addSphereSceneNode</span><span class="p">();</span>

	  <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
  	      <span class="n">node</span><span class="o">-&gt;</span><span class="n">setPosition</span><span class="p">(</span><span class="n">core</span><span class="o">::</span><span class="n">vector3df</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">));</span>
	      <span class="n">node</span><span class="o">-&gt;</span><span class="n">setMaterialTexture</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">getTexture</span><span class="p">(</span><span class="n">textureFile</span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
	      <span class="n">node</span><span class="o">-&gt;</span><span class="n">setMaterialFlag</span><span class="p">(</span><span class="n">video</span><span class="o">::</span><span class="n">EMF_LIGHTING</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	  <span class="p">}</span>

	  <span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">setNodePosition</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">LuaTable</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">);</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">);</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">pos</span><span class="p">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;z&quot;</span><span class="p">);</span>

        <span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">setPosition</span><span class="p">(</span><span class="n">core</span><span class="o">::</span><span class="n">vector3df</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">LuaTable</span> <span class="nf">getNodePosition</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LuaTable</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">luaState</span><span class="p">.</span><span class="n">CreateTable</span><span class="p">();</span>

        <span class="n">core</span><span class="o">::</span><span class="n">vector3df</span> <span class="n">v</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getPosition</span><span class="p">();</span>

        <span class="n">pos</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>
        <span class="n">pos</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>
        <span class="n">pos</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
    <span class="p">}</span>
  </code></pre></figure>

<p>Given those, we have our API and are able to create and run our first Lua script.
Add one in the <code>media/scripts/</code> directory:</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="n">createSphere</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">sphere1&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">media/textures/wall.bmp&quot;</span><span class="p">)</span></code></pre></figure>

<p><strong>Note:</strong> paths in the script will be used by C++ core, relatively to the binary file, which
is… generated by our C++ code! So all the paths in the scripts are just the same as they
are in C++ core.</p>

<p>And add the <code>ScriptManager</code> initialization code:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">ScriptManager</span> <span class="o">*</span><span class="n">scriptMgr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScriptManager</span><span class="p">(</span><span class="n">smgr</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>

<span class="n">scriptMgr</span><span class="o">-&gt;</span><span class="n">loadScript</span><span class="p">(</span><span class="s">&quot;media/scripts/test1.lua&quot;</span><span class="p">);</span></code></pre></figure>

<p>Now you may remove the code, creating sphere in the <code>main()</code> function. And run the code.
You should see exactly the same picture as before:</p>

<p><img src="/irrlicht-newton-tutorials/images/04_movement_untouched.png" alt="_screenshot #1_" /></p>

<h2 id="homework">Homework</h2>

<p>Your task is: try to move all the other “factory” functions <em>(creating cube, ninja,
circle animator for cube and fly animator for Ninja)</em> to Lua script, adding API for them
to <code>ScriptManager</code>.</p>

<h2 id="more-separation">More separation</h2>

<p>We will now advance our script and add some convention to it. These will be our tasks
for the rest of this chapter:</p>

<ol>
  <li>move keyboard events handling to script</li>
  <li>create two function in script so we may call them <em>by convention, not by configuration</em></li>
</ol>

<p>The last phrase I took from <strong>Ember.js introduction</strong>. It says <em>“prefer convention over
configuration”</em>, meaning we’d better call the functions of same name on different scripts,
instead of setting somehow which function to call.</p>

<p>That is, we will define <code>handleFrame()</code> function in our script, which will be called
on each <code>onFrame</code> event in our C++ core and the <code>main()</code> function, which will be called right
after script has been loaded.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">auto</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">luaState</span><span class="p">.</span><span class="n">GetGlobalEnvironment</span><span class="p">().</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">LuaFunction</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&quot;handleFrame&quot;</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="n">handler</span><span class="p">.</span><span class="n">Invoke</span><span class="p">();</span></code></pre></figure>

<p>Moreover, we will define a global keyboard state table for each of scripts we load and will
be updating it as user presses keys on his keyboard. And this variable will be shared with
script, but as read-only one. So changes in that table will have no effect on the application
itself.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">ScriptManager</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;</span> <span class="n">keyStates</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">setGlobalVariables</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">setKeyStates</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">setKeyStates</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">LuaTable</span> <span class="n">keysTable</span> <span class="o">=</span> <span class="n">luaState</span><span class="p">.</span><span class="n">CreateTable</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">kv</span> <span class="p">:</span> <span class="n">keyStates</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">keysTable</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">kv</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">kv</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">luaState</span><span class="p">.</span><span class="n">GetGlobalEnvironment</span><span class="p">().</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;KEY_STATE&quot;</span><span class="p">,</span> <span class="n">keysTable</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">setKeyState</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">keyStates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">handleFrame</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">luaState</span><span class="p">.</span><span class="n">GetGlobalEnvironment</span><span class="p">().</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">LuaFunction</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&quot;handleFrame&quot;</span><span class="p">);</span>

        <span class="n">setKeyStates</span><span class="p">();</span>

        <span class="n">handler</span><span class="p">.</span><span class="n">Invoke</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">loadScript</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">inf</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">code</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">istreambuf_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inf</span><span class="p">)),</span> <span class="n">std</span><span class="o">::</span><span class="n">istreambuf_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">());</span>

        <span class="n">bindFunctions</span><span class="p">();</span>
        <span class="n">setGlobalVariables</span><span class="p">();</span>

        <span class="n">luaState</span><span class="p">.</span><span class="n">RunScript</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>

        <span class="k">auto</span> <span class="n">scriptMainFn</span> <span class="o">=</span> <span class="n">luaState</span><span class="p">.</span><span class="n">GetGlobalEnvironment</span><span class="p">().</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">LuaFunction</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">);</span>
        <span class="n">scriptMainFn</span><span class="p">.</span><span class="n">Invoke</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">MyEventReceiver</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IEventReceiver</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">MyEventReceiver</span><span class="p">(</span><span class="n">ScriptManager</span> <span class="o">*</span><span class="n">scriptManager</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">scriptMgr</span> <span class="o">=</span> <span class="n">scriptManager</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">KEY_KEY_CODES_COUNT</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">scriptMgr</span><span class="o">-&gt;</span><span class="n">setKeyState</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// This is the one method that we have to implement</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">OnEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">SEvent</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Remember whether each key is down or up</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">EventType</span> <span class="o">==</span> <span class="n">irr</span><span class="o">::</span><span class="n">EET_KEY_INPUT_EVENT</span><span class="p">)</span>
            <span class="n">scriptMgr</span><span class="o">-&gt;</span><span class="n">setKeyState</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">KeyInput</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">KeyInput</span><span class="p">.</span><span class="n">PressedDown</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">ScriptManager</span> <span class="o">*</span><span class="n">scriptMgr</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure>

<p>Variables are added to a <code>GlobalEnvironment</code> just as function do:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">luaState</span><span class="p">.</span><span class="n">GetGlobalEnvironment</span><span class="p">().</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;KEY_STATE&quot;</span><span class="p">,</span> <span class="n">keysTable</span><span class="p">);</span></code></pre></figure>

<p>Lua-defined functions are found by their names and called with <code>Invoke(args)</code> method:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">auto</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">luaState</span><span class="p">.</span><span class="n">GetGlobalEnvironment</span><span class="p">().</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">LuaFunction</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&quot;handleFrame&quot;</span><span class="p">);</span>

<span class="n">handler</span><span class="p">.</span><span class="n">Invoke</span><span class="p">();</span></code></pre></figure>

<p>Let’s add some simple interaction to our script now. I’ll help you a bit:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="nf">moveNode</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">LuaTable</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">scene</span><span class="o">::</span><span class="n">ISceneNode</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">findNode</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="n">core</span><span class="o">::</span><span class="n">vector3df</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">tableToVector3df</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>

    <span class="n">core</span><span class="o">::</span><span class="n">matrix4</span> <span class="n">m</span><span class="p">;</span>

    <span class="n">core</span><span class="o">::</span><span class="n">vector3df</span> <span class="n">rot</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">getRotation</span><span class="p">();</span>
    <span class="n">m</span><span class="p">.</span><span class="n">setRotationDegrees</span><span class="p">(</span><span class="n">rot</span><span class="p">);</span>

    <span class="n">m</span><span class="p">.</span><span class="n">transformVect</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span>
    <span class="n">node</span><span class="o">-&gt;</span><span class="n">setPosition</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">getPosition</span><span class="p">()</span> <span class="o">+</span> <span class="n">vec</span><span class="p">);</span>
    <span class="n">node</span><span class="o">-&gt;</span><span class="n">updateAbsolutePosition</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>This is how nodes could be moved relatively to their current position in Irrlicht.</p>

<p>And here’s how our Lua script may look like now:</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="k">function</span> <span class="nf">handleFrame</span><span class="p">()</span>
    <span class="c1">-- w</span>
    <span class="k">if</span> <span class="n">KEY_STATE</span><span class="p">[</span><span class="mh">0x57</span><span class="p">]</span> <span class="o">==</span> <span class="kc">true</span> <span class="k">then</span>
        <span class="n">move</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">sphere1&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">})</span>
    <span class="k">end</span>

    <span class="c1">-- s</span>
    <span class="k">if</span> <span class="n">KEY_STATE</span><span class="p">[</span><span class="mh">0x53</span><span class="p">]</span> <span class="o">==</span> <span class="kc">true</span> <span class="k">then</span>
        <span class="n">move</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">sphere1&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">})</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">main</span><span class="p">()</span>
    <span class="n">createSphere</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">sphere1&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">media/textures/wall.bmp&quot;</span><span class="p">)</span>
    <span class="n">setPosition</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">sphere1&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">30</span> <span class="p">})</span>

    <span class="n">createCube</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">cube1&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">media/textures/t351sml.jpg&quot;</span><span class="p">)</span>
    <span class="n">addCircleAnimator</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">cube1&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">30</span> <span class="p">},</span> <span class="mf">20.0</span><span class="p">)</span>

    <span class="n">createAnimatedMesh</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ninja&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">media/models/ninja.b3d&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">media/textures/nskinbl.jpg&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">setRotation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ninja&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">})</span>
    <span class="n">setScale</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ninja&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">})</span>
    <span class="n">addForwardAnimator</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ninja&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">60</span> <span class="p">},</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">60</span> <span class="p">},</span> <span class="mi">3500</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>If you run our application <em>now</em>, you should be able to control sphere with <kbd>w</kbd> and
<kbd>s</kbd> keys:</p>

<p><img src="/irrlicht-newton-tutorials/images/lua_script_with_kbd_handling.png" alt="_screenshot #2_" /></p>


  <div class="row">
    <div class="col-sm-12">
      <span class="label label-primary">Nov 15, 2015</span>
      
      
    </div>
  </div>
</div>

          </div>
        </div>
      </div>
    </div>

    <script>
  if (document.location.hostname.search("shybovycha.github.io") !== -1) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-42282809-1', 'auto');
    ga('send', 'pageview');
  }
</script>

  </body>
</html>
